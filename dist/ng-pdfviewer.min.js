angular.module("ngPDFViewer",[]).directive("pdfviewer",[function(){return{restrict:"E",template:'<canvas id="{{id}}" class="cursor-move" ng-mouseleave="canMove=false" ng-mousedown="canMove=true" ng-mouseup="canMove=false" ng-init="canMove=false" ng-mousemove="mouseDrag($event,canMove)"></canvas>',scope:{onPageLoad:"&",loadProgress:"&",src:"@",stream:"=",id:"=",scale:"@"},controller:["$scope",function(e){e.pageNum=1,e.pdfDoc=null;var n=!1,a={x:-1,y:-1,deltaX:0,deltaY:0};e.mouseDrag=function(n,o){if(o){n.preventDefault();var t=n.offsetX+a.deltaX-a.x,r=n.offsetY+a.deltaY-a.y;e.canvasElement[0].scrollLeft-t>0&&(e.canvasElement[0].scrollLeft-=t,a.x=n.offsetX,a.deltaX=t),e.canvasElement[0].scrollTop-r>0&&(e.canvasElement[0].scrollTop-=r,a.y=n.offsetY,a.deltaY=r)}else a.x=n.offsetX,a.y=n.offsetY},e.documentProgress=function(n){e.loadProgress&&e.loadProgress({state:"loading",loaded:n.loaded,total:n.total})},e.loadPDF=function(n){PDFJS.getDocument(n,null,null,e.documentProgress).then(function(n){e.pdfDoc=n,e.renderPage(e.pageNum,!1,function(){e.loadProgress&&e.loadProgress({state:"finished",loaded:0,total:0})})},function(n){console.log("PDF load error: "+n),e.loadProgress&&e.loadProgress({state:"error",loaded:0,total:0})})},e.loadStream=function(n){PDFJS.getDocument({data:n},null,null,e.documentProgress).then(function(n){e.pdfDoc=n,e.renderPage(e.pageNum,!1,function(){e.loadProgress&&e.loadProgress({state:"finished",loaded:0,total:0})})},function(n){console.log("PDF load error: "+n),e.loadProgress&&e.loadProgress({state:"error",loaded:0,total:0})})},e.renderPage=function(n,a,o){e.pdfDoc.getPage(n).then(function(n){a||(e.scale=e.viewSize().width/n.pageInfo.view[2]);var t=n.getViewport(e.scale),r=e.canvas.getContext("2d");e.canvas.height=t.height,e.canvas.width=t.width,n.render({canvasContext:r,viewport:t}).promise.then(function(){o&&o(!0),e.$apply(function(){e.onPageLoad({page:e.pageNum,total:e.pdfDoc.numPages})})},function(){o&&o(!1),console.log("page.render failed")})})},e.$on("pdfviewer.nextPage",function(n,a){a===e.instance_id&&e.pageNum<e.pdfDoc.numPages&&(e.pageNum++,e.renderPage(e.pageNum,!1))}),e.$on("pdfviewer.prevPage",function(n,a){a===e.instance_id&&e.pageNum>1&&(e.pageNum--,e.renderPage(e.pageNum,!1))}),e.$on("pdfviewer.gotoPage",function(n,a,o){a===e.instance_id&&o>=1&&o<=e.pdfDoc.numPages&&(e.pageNum=o,e.renderPage(e.pageNum,!1))}),e.$on("pdfviewer.zoomIn",function(a,o){o===e.instance_id&&parseFloat(e.scale)+.2<5&&(e.scale=parseFloat(e.scale)+.2,n=!0,e.renderPage(e.pageNum,!0))}),e.$on("pdfviewer.zoomOut",function(a,o){o===e.instance_id&&parseFloat(e.scale)-.2>0&&(e.scale=parseFloat(e.scale)-.2,n=!0,e.renderPage(e.pageNum,!0))}),e.$on("pdfviewer.refresh",function(a,o){o===e.instance_id&&e.renderPage(e.pageNum,n)})}],link:function(e,n,a){e.canvas=n.find("canvas")[0],e.canvasElement=angular.element(n.find("canvas")[0].parentElement.parentElement),e.viewSize=function(){return{width:e.canvasElement[0].clientWidth,height:e.canvasElement[0].clientHeight}},e.instance_id=a.id,PDFJS.disableWorker=!0,a.$observe("src",function(n){void 0!==n&&null!==n&&""!==n&&(e.pageNum=1,e.loadPDF(e.src))}),e.$watch("stream",function(n){void 0!==n&&null!==n&&""!==n&&(e.pageNum=1,e.loadStream(n))})}}}]).service("PDFViewerService",["$rootScope",function(e){var n={};return n.nextPage=function(){e.$broadcast("pdfviewer.nextPage")},n.prevPage=function(){e.$broadcast("pdfviewer.prevPage")},n.zoomIn=function(){e.$broadcast("pdfviewer.zoomIn")},n.zoomOut=function(){e.$broadcast("pdfviewer.zoomOut")},n.refresh=function(){e.$broadcast("pdfviewer.refresh")},n.Instance=function(n){var a=n;return{prevPage:function(){e.$broadcast("pdfviewer.prevPage",a)},nextPage:function(){e.$broadcast("pdfviewer.nextPage",a)},zoomIn:function(){e.$broadcast("pdfviewer.zoomIn",a)},zoomOut:function(){e.$broadcast("pdfviewer.zoomOut",a)},gotoPage:function(n){e.$broadcast("pdfviewer.gotoPage",a,n)},refresh:function(){e.$broadcast("pdfviewer.refresh",a)}}},n}]);